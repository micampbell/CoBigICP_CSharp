function  [H,b,J]  = CalHbCobig_Gabor(Mov, PtsDiff, R, RefNormInfo, MovNormInfo, sigma)

p1 = Mov(1,:);
p2 = Mov(2,:);
p3 = Mov(3,:);

v1 = PtsDiff(1,:);
v2 = PtsDiff(2,:);
v3 = PtsDiff(3,:);

infoRMat = cat(2, RefNormInfo(:).omega);
infoR1 = infoRMat(1, 1:3:end);
infoR2 = infoRMat(1, 2:3:end);
infoR3 = infoRMat(1, 3:3:end);
infoR4 = infoRMat(2, 2:3:end);
infoR5 = infoRMat(2, 3:3:end);
infoR6 = infoRMat(3, 3:3:end);
infoMMat = cat(2, MovNormInfo(:).omega);
infoM1 = infoMMat(1, 1:3:end);
infoM2 = infoMMat(1, 2:3:end);
infoM3 = infoMMat(1, 3:3:end);
infoM4 = infoMMat(2, 2:3:end);
infoM5 = infoMMat(2, 3:3:end);
infoM6 = infoMMat(3, 3:3:end);
R1 = R(1, 1);
R2 = R(1, 2);
R3 = R(1, 3);
R4 = R(2, 1);
R5 = R(2, 2);
R6 = R(2, 3);
R7 = R(3, 1);
R8 = R(3, 2);
R9 = R(3, 3);

infobi = [];
infobi(end+1, :) = infoR1+(R1.*R1).*infoM1+(R2.*R2).*infoM4+(R3.*R3).*infoM6+R1.*R2.*infoM2*2.0+R1.*R3.*infoM3*2.0+R2.*R3.*infoM5*2.0;
infobi(end+1, :) = infoR2+R4.*(R1.*infoM1+R2.*infoM2+R3.*infoM3)+R5.*(R1.*infoM2+R2.*infoM4+R3.*infoM5)+R6.*(R1.*infoM3+R2.*infoM5+R3.*infoM6);
infobi(end+1, :) = infoR3+R7.*(R1.*infoM1+R2.*infoM2+R3.*infoM3)+R8.*(R1.*infoM2+R2.*infoM4+R3.*infoM5)+R9.*(R1.*infoM3+R2.*infoM5+R3.*infoM6);
infobi(end+1, :) = infoR4+(R4.*R4).*infoM1+(R5.*R5).*infoM4+(R6.*R6).*infoM6+R4.*R5.*infoM2*2.0+R4.*R6.*infoM3*2.0+R5.*R6.*infoM5*2.0;
infobi(end+1, :) = infoR5+R7.*(R4.*infoM1+R5.*infoM2+R6.*infoM3)+R8.*(R4.*infoM2+R5.*infoM4+R6.*infoM5)+R9.*(R4.*infoM3+R5.*infoM5+R6.*infoM6);
infobi(end+1, :) = infoR6+(R7.*R7).*infoM1+(R8.*R8).*infoM4+(R9.*R9).*infoM6+R7.*R8.*infoM2*2.0+R7.*R9.*infoM3*2.0+R8.*R9.*infoM5*2.0;
% MArray = sum(infobi, 2);

m1 = infobi(1,:);
m2 = infobi(2,:);
m3 = infobi(3,:);
m4 = infobi(4,:);
m5 = infobi(5,:);
m6 = infobi(6,:);

w = -exp(-(v1.*(m1.*v1 + m2.*v2 + m3.*v3) + v2.*(m2.*v1 + m4.*v2 + m5.*v3) + v3.*(m3.*v1 + m5.*v2 + m6.*v3))/(2.*sigma^2))/sigma^2;
H = [];
H(end+1, :) = w.*(m4.*(p3.*p3)+m6.*(p2.*p2)-m5.*p2.*p3*2.0);
H(end+1, :) = -p3.*(m2.*p3.*w-m3.*p2.*w)+p1.*(m5.*p3.*w-m6.*p2.*w);
H(end+1, :) = p2.*(m2.*p3.*w-m3.*p2.*w)-p1.*(m4.*p3.*w-m5.*p2.*w);
H(end+1, :)  = -w.*(m2.*p3-m3.*p2);
H(end+1, :)  = -w.*(m4.*p3-m5.*p2);
H(end+1, :)  = -w.*(m5.*p3-m6.*p2);
H(end+1, :)  = -p3.*(m2.*p3.*w-m5.*p1.*w)+p2.*(m3.*p3.*w-m6.*p1.*w);
H(end+1, :)  = w.*(m1.*(p3.*p3)+m6.*(p1.*p1)-m3.*p1.*p3*2.0);
H(end+1, :) = -p2.*(m1.*p3.*w-m3.*p1.*w)+p1.*(m2.*p3.*w-m5.*p1.*w);
H(end+1, :)  = w.*(m1.*p3-m3.*p1);
H(end+1, :)  = w.*(m2.*p3-m5.*p1);
H(end+1, :) = w.*(m3.*p3-m6.*p1);
H(end+1, :)  = p3.*(m2.*p2.*w-m4.*p1.*w)-p2.*(m3.*p2.*w-m5.*p1.*w);
H(end+1, :)  = -p3.*(m1.*p2.*w-m2.*p1.*w)+p1.*(m3.*p2.*w-m5.*p1.*w);
H(end+1, :)  = w.*(m1.*(p2.*p2)+m4.*(p1.*p1)-m2.*p1.*p2*2.0);
H(end+1, :)  = -w.*(m1.*p2-m2.*p1);
H(end+1, :)  = -w.*(m2.*p2-m4.*p1);
H(end+1, :)  = -w.*(m3.*p2-m5.*p1);
H(end+1, :)  = -w.*(m2.*p3-m3.*p2);
H(end+1, :)  = w.*(m1.*p3-m3.*p1);
H(end+1, :)  = -w.*(m1.*p2-m2.*p1);
H(end+1, :)  = m1.*w;
H(end+1, :)  = m2.*w;
H(end+1, :)  = m3.*w;
H(end+1, :)  = -w.*(m4.*p3-m5.*p2);
H(end+1, :)  = w.*(m2.*p3-m5.*p1);
H(end+1, :)  = -w.*(m2.*p2-m4.*p1);
H(end+1, :)  = m2.*w;
H(end+1, :)  = m4.*w;
H(end+1, :)  = m5.*w;
H(end+1, :)  = -w.*(m5.*p3-m6.*p2);
H(end+1, :)  = w.*(m3.*p3-m6.*p1);
H(end+1, :) = -w.*(m3.*p2-m5.*p1);
H(end+1, :)  = m3.*w;
H(end+1, :)  = m5.*w;
H(end+1, :)  = m6.*w;
H = reshape( sum(H, 2), 6, 6);

b = [];
b(end+1, :) = -v1.*(m2.*p3.*w-m3.*p2.*w)-v2.*(m4.*p3.*w-m5.*p2.*w)-v3.*(m5.*p3.*w-m6.*p2.*w);
b(end+1, :) = v1.*(m1.*p3.*w-m3.*p1.*w)+v2.*(m2.*p3.*w-m5.*p1.*w)+v3.*(m3.*p3.*w-m6.*p1.*w);
b(end+1, :) = -v1.*(m1.*p2.*w-m2.*p1.*w)-v2.*(m2.*p2.*w-m4.*p1.*w)-v3.*(m3.*p2.*w-m5.*p1.*w);
b(end+1, :) = w.*(m1.*v1+m2.*v2+m3.*v3);
b(end+1, :) = w.*(m2.*v1+m4.*v2+m5.*v3);
b(end+1, :) = w.*(m3.*v1+m5.*v2+m6.*v3);
b = sum(b, 2);

J = m1.*(v1.*v1)+m4.*(v2.*v2)+m6.*(v3.*v3)+m2.*v1.*v2*2.0+m3.*v1.*v3*2.0+m5.*v2.*v3*2.0;
J = sum(J);